const OpenAI = require("openai");
require("dotenv").config();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function getSuggestionsAvoidingAllPatterns(inputText, patternList) {
  const allPatternsText = patternList
    .map((p, i) => `${i + 1}. ${p.title} - ${p.definition}`)
    .join("\n");

  const bannedWords = [
    // ðŸ“› ì‹œê°„ ì••ë°• ê´€ë ¨ ë‹¨ì–´ (urgency)
    "ì§€ê¸ˆ", "ì¦‰ì‹œ", "ë¹ ë¥´ê²Œ", "ì„œë‘˜ëŸ¬", "ì˜¤ëŠ˜ë§Œ", "ê¸°ê°„ í•œì •", "í•œì •", "ì¡°ì†ížˆ", "ê³§ ì¢…ë£Œ",

    // ðŸ“› ê¸ˆì „ì  ìœ ë„ ë° ê³¼ìž¥ (sneaking, misdirection, obstruction ë“±)
    "í˜œíƒ", "í• ì¸", "ìµœëŒ€", "ì¿ í°", "ë¬´ë£Œ", "ì™€ë¥´ë¥´", "íŠ¹ë³„", "ì œê³µë©ë‹ˆë‹¤", "ë°›ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤", "ê²½í—˜í•´ë³´ì„¸ìš”", "ì ˆì•½"
  ];

  const prompt = `
ë„ˆëŠ” ë‹¤í¬íŒ¨í„´ì„ ì œê±°í•˜ê³ , ì‚¬ìš©ìžê°€ ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” UX ë¬¸ìž¥ì„ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ë‹¤.

ë‹¤ìŒì€ í”¼í•´ì•¼ í•  ë‹¤í¬íŒ¨í„´ ìœ í˜•ë“¤ì´ë‹¤:
${allPatternsText}

ì‚¬ìš©ìž ìž…ë ¥ ë¬¸ìž¥ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:
"${inputText}"

ì´ ë¬¸ìž¥ì˜ **í•µì‹¬ ì˜ë¯¸ëŠ” ìœ ì§€í•˜ë˜**, ë‹¤ìŒ ì¡°ê±´ì„ **ì ˆëŒ€ì ìœ¼ë¡œ ì§€ì¼œì„œ** ë¬¸ìž¥ 2ê°œë§Œ ìƒì„±í•˜ë¼:

**ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ì•„ì•¼ í•  í‘œí˜„ë“¤**:
${bannedWords.join(", ")}

**ì§€ì¼œì•¼ í•  ì¡°ê±´**:
1. ìœ„ ë‹¨ì–´ ë˜ëŠ” ìœ ì‚¬ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ (ë‹¨ì–´ê°€ ì¼ë¶€ë¼ë„ í¬í•¨ë˜ë©´ ì•ˆ ë¨)
2. ë‹¤í¬íŒ¨í„´ ìœ í˜•(ê°•ì œ, ê³¼ìž¥, í˜œíƒ ê°•ì¡°, ì‹œê°„ ì••ë°•, ìœ ë„ ë“±)ì— ìœ„ë°˜ë˜ì§€ ì•Šì„ ê²ƒ
3. ì‚¬ìš©ìžì˜ ì„ íƒì€ ìžìœ ë¡­ê²Œ, ì •ë³´ëŠ” ì¤‘ë¦½ì ì´ê³  ì‚¬ì‹¤ ê¸°ë°˜ìœ¼ë¡œ ì œì‹œí•  ê²ƒ
4. ê°ì • ìœ ë„, ë¶ˆì•ˆ ì¡°ì„±, ê³¼ë„í•œ ìœ ë„/ê°•ì¡° í‘œí˜„ì€ ì‚¬ìš© ê¸ˆì§€
5. ì‚¬ìš©ìžê°€ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•  ìˆ˜ ìžˆë„ë¡ ê¸°ëŠ¥/ì •ë³´ ìœ„ì£¼ë¡œ ìž‘ì„±í•  ê²ƒ

â— **1ë²ˆ ë¬¸ìž¥ì€ ê°€ìž¥ ì ì ˆí•˜ê³  ì¶”ì²œí•  ìˆ˜ ìžˆëŠ” ë¬¸ìž¥ì´ì–´ì•¼ í•œë‹¤.**
2ë²ˆ ë¬¸ìž¥ì€ ëŒ€ì•ˆ ë¬¸ìž¥ìœ¼ë¡œ ì œê³µí•´ë¼.

**ì¶œë ¥ í˜•ì‹ (ìˆ«ìžì™€ ë¬¸ìž¥ë§Œ í¬í•¨):**
1. ...
2. ...
`;

  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [
      {
        role: "system",
        content:
          "ë„ˆëŠ” UX ë””ìžì´ë„ˆì´ìž ìœ¤ë¦¬ì  ì¹´í”¼ë¼ì´íŒ… ì „ë¬¸ê°€ë¡œì„œ ì‚¬ìš©ìžì—ê²Œ ì‹ ë¢° ê°€ëŠ¥í•œ ì„¤ëª…ë§Œ ì œê³µí•œë‹¤.",
      },
      { role: "user", content: prompt },
    ],
    temperature: 0.5,
  });

  const output = response.choices[0].message.content;

  return output
    .trim()
    .split("\n")
    .filter((line) => /^\d+\.\s/.test(line));
}

module.exports = { getSuggestionsAvoidingAllPatterns };
